<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>OAuth Debug</title>
</head>

<body>
    <h2>OAuth Debug Page</h2>
    <p id="status">Starting debug...</p>

    <h3>URL Information:</h3>
    <pre id="url-info"></pre>

    <h3>Console Log:</h3>
    <pre id="console"></pre>

    <script>
        function log(message) {
            const console = document.getElementById('console');
            console.textContent += new Date().toISOString() + ': ' + message + '\n';
            window.console.log(message);
        }

        log('Script started');

        // Show URL info
        document.getElementById('url-info').textContent =
            'Full URL: ' + window.location.href + '\n' +
            'Search: ' + window.location.search + '\n' +
            'Hash: ' + window.location.hash;

        // Get URL parameters
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const error = params.get('error');

        log('Code: ' + (code || 'MISSING'));
        log('Error: ' + (error || 'NONE'));

        if (error) {
            document.getElementById('status').textContent = 'OAuth Error: ' + error;
            log('GitHub returned error: ' + error);
        } else if (code) {
            document.getElementById('status').textContent = 'Code received, testing fetch...';
            log('Starting token exchange with code: ' + code.substring(0, 10) + '...');

            // Test the /oauth endpoint
            fetch('/oauth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code: code })
            })
                .then(response => {
                    log('Response status: ' + response.status);
                    log('Response ok: ' + response.ok);
                    return response.text();
                })
                .then(text => {
                    log('Response text: ' + text);
                    try {
                        const data = JSON.parse(text);
                        log('Parsed JSON: ' + JSON.stringify(data));

                        if (data.token) {
                            document.getElementById('status').textContent = 'Success! Token received.';
                            log('Token received successfully');

                            // Just show success, don't try to close window yet
                            setTimeout(() => {
                                alert('Authentication successful! Token: ' + data.token.substring(0, 10) + '...');
                            }, 1000);
                        } else {
                            document.getElementById('status').textContent = 'No token in response';
                            log('No token found in response');
                        }
                    } catch (e) {
                        log('Failed to parse JSON: ' + e.message);
                        document.getElementById('status').textContent = 'Invalid JSON response';
                    }
                })
                .catch(error => {
                    log('Fetch error: ' + error.message);
                    document.getElementById('status').textContent = 'Fetch failed: ' + error.message;
                });
        } else {
            document.getElementById('status').textContent = 'No code or error in URL';
            log('No code or error parameter found');
        }
    </script>
</body>

</html>