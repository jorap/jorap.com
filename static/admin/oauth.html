<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Redirecting...</title>
</head>

<body>
    <p>Completing authentication...</p>
    <script>
        // OAuth callback handler for GitHub with Decap CMS on Cloudflare Pages
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const error = params.get('error');

        if (error) {
            alert('Authentication error: ' + error);
            if (window.opener) {
                window.opener.postMessage({
                    type: 'authorization_github',
                    error: error
                }, window.location.origin);
                window.close();
            }
            return;
        }

        if (code) {
            // Exchange code for token using Cloudflare function
            fetch('/oauth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code: code })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.token) {
                        // Post message to parent window (CMS)
                        if (window.opener) {
                            window.opener.postMessage({
                                type: 'authorization_github',
                                token: data.token
                            }, window.location.origin);
                            window.close();
                        } else {
                            // Fallback: redirect to admin with token in hash
                            window.location.href = '/admin/#access_token=' + data.token;
                        }
                    } else {
                        console.error('Token exchange failed:', data);
                        alert('Authentication failed: ' + (data.error || 'Unknown error'));
                        if (window.opener) {
                            window.opener.postMessage({
                                type: 'authorization_github',
                                error: data.error || 'Token exchange failed'
                            }, window.location.origin);
                            window.close();
                        }
                    }
                })
                .catch(error => {
                    console.error('OAuth error:', error);
                    alert('Authentication error: ' + error.message);
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'authorization_github',
                            error: error.message
                        }, window.location.origin);
                        window.close();
                    }
                });
        } else {
            alert('No authorization code received');
        }
    </script>
</body>

</html>