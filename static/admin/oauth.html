<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Redirecting...</title>
</head>

<body>
    <div id="status">Completing authentication...</div>
    <div id="debug"
        style="margin-top: 20px; font-family: monospace; font-size: 12px; color: #666; white-space: pre-wrap;"></div>

    <script>
        // Add error handler for uncaught errors
        window.addEventListener('error', function (e) {
            document.getElementById('status').textContent = 'JavaScript Error: ' + e.message;
            document.getElementById('debug').textContent = 'Error: ' + e.message + '\nFile: ' + e.filename + '\nLine: ' + e.lineno;
        });

        // Test basic functionality first
        try {
            document.getElementById('status').textContent = 'JavaScript is working, checking URL...';
        } catch (e) {
            alert('Basic DOM manipulation failed: ' + e.message);
        }
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log(message);
        }

        function addDebug(message) {
            const debugDiv = document.getElementById('debug');
            debugDiv.innerHTML += message + '<br>';
            console.log('DEBUG:', message);
        }

        // OAuth callback handler for GitHub with Decap CMS on Cloudflare Pages
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const error = params.get('error');
        const state = params.get('state');

        addDebug('URL: ' + window.location.href);
        addDebug('Code: ' + (code ? 'Present' : 'Missing'));
        addDebug('Error: ' + (error || 'None'));
        addDebug('State: ' + (state || 'None'));

        if (error) {
            updateStatus('Authentication error: ' + error);
            addDebug('GitHub returned error: ' + error);
            if (window.opener) {
                window.opener.postMessage({
                    type: 'authorization_github',
                    error: error
                }, window.location.origin);
                window.close();
            }
            return;
        }

        if (code) {
            updateStatus('Exchanging code for token...');
            addDebug('Starting token exchange with code: ' + code.substring(0, 10) + '...');

            // Exchange code for token using Cloudflare function
            fetch('/oauth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code: code })
            })
                .then(response => {
                    addDebug('Response status: ' + response.status);
                    addDebug('Response headers: ' + JSON.stringify(Object.fromEntries([...response.headers])));

                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    addDebug('Response data: ' + JSON.stringify(data));

                    if (data.token) {
                        updateStatus('Authentication successful! Redirecting...');
                        addDebug('Token received, posting message to parent');

                        // Post message to parent window (CMS)
                        if (window.opener) {
                            window.opener.postMessage({
                                type: 'authorization_github',
                                token: data.token
                            }, window.location.origin);

                            setTimeout(() => {
                                window.close();
                            }, 1000);
                        } else {
                            addDebug('No window.opener, using fallback redirect');
                            // Fallback: redirect to admin with token in hash
                            window.location.href = '/admin/#access_token=' + data.token;
                        }
                    } else {
                        updateStatus('Token exchange failed');
                        addDebug('No token in response: ' + JSON.stringify(data));
                        alert('Authentication failed: ' + (data.error || 'No token received'));

                        if (window.opener) {
                            window.opener.postMessage({
                                type: 'authorization_github',
                                error: data.error || 'Token exchange failed'
                            }, window.location.origin);
                            window.close();
                        }
                    }
                })
                .catch(error => {
                    updateStatus('Error during authentication');
                    addDebug('Fetch error: ' + error.message);
                    addDebug('Error stack: ' + error.stack);
                    alert('Authentication error: ' + error.message);

                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'authorization_github',
                            error: error.message
                        }, window.location.origin);
                        window.close();
                    }
                });
        } else {
            updateStatus('No authorization code received');
            addDebug('No code parameter in URL');
            alert('No authorization code received. Please try again.');
        }
    </script>
</body>

</html>