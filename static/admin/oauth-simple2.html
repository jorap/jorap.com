<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>OAuth Handler</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 10px 0; padding: 10px; border-left: 3px solid #ccc; }
        .success { border-left-color: #4CAF50; background: #f0f8f0; }
        .error { border-left-color: #f44336; background: #fff0f0; }
        .pending { border-left-color: #ff9800; background: #fff8f0; }
    </style>
</head>
<body>
    <h1>OAuth Authentication</h1>
    <div id="steps"></div>
    
    <script>
        function addStep(message, type = 'pending') {
            const steps = document.getElementById('steps');
            const step = document.createElement('div');
            step.className = `step ${type}`;
            step.textContent = message;
            steps.appendChild(step);
            console.log(message);
        }
        
        function updateLastStep(message, type) {
            const steps = document.getElementById('steps');
            const lastStep = steps.lastElementChild;
            if (lastStep) {
                lastStep.textContent = message;
                lastStep.className = `step ${type}`;
            }
        }
        
        // Step 1: Check URL
        addStep('Step 1: Checking URL parameters...');
        const url = new URL(window.location.href);
        const code = url.searchParams.get('code');
        const error = url.searchParams.get('error');
        
        if (error) {
            updateLastStep(`Step 1: Error from GitHub: ${error}`, 'error');
        } else if (code) {
            updateLastStep(`Step 1: Authorization code received: ${code.substring(0, 10)}...`, 'success');
            
            // Step 2: Exchange code for token
            addStep('Step 2: Exchanging code for access token...');
            
            fetch('/oauth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            })
            .then(response => {
                addStep(`Step 3: Server responded with status ${response.status}`);
                return response.text();
            })
            .then(responseText => {
                addStep('Step 4: Processing server response...');
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    updateLastStep('Step 4: Response parsed successfully', 'success');
                } catch (e) {
                    updateLastStep(`Step 4: JSON parse error: ${e.message}`, 'error');
                    addStep(`Raw response: ${responseText}`, 'error');
                    return;
                }
                
                if (data.token) {
                    addStep(`Step 5: Access token received!`, 'success');
                    addStep(`Token starts with: ${data.token.substring(0, 20)}...`, 'success');
                    
                    // Try to complete authentication
                    addStep('Step 6: Completing authentication...');
                    
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'authorization_github',
                            token: data.token
                        }, window.location.origin);
                        
                        addStep('Step 7: Sent token to parent window, closing...', 'success');
                        setTimeout(() => window.close(), 2000);
                    } else {
                        addStep('Step 7: No parent window, redirecting to admin...', 'pending');
                        setTimeout(() => {
                            window.location.href = '/admin/';
                        }, 2000);
                    }
                } else {
                    addStep(`Step 5: No token received - ${data.error || 'Unknown error'}`, 'error');
                    if (data.details) {
                        addStep(`Details: ${JSON.stringify(data.details)}`, 'error');
                    }
                }
            })
            .catch(fetchError => {
                updateLastStep(`Step 2: Fetch failed: ${fetchError.message}`, 'error');
            });
            
        } else {
            updateLastStep('Step 1: No authorization code or error found in URL', 'error');
        }
    </script>
</body>
</html> 